// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication and authorization
model User {
  id             String    @id @default(cuid())
  email          String    @unique
  hashedPassword String
  name           String?
  role           Role      @default(EDITOR)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  articles       Article[]
  guides         Guide[]
  calculators    Calculator[]
  contentVersions ContentVersion[]
}

enum Role {
  ADMIN
  EDITOR
  PARTNER
}

// Content Type: Article
// For blog posts, news, and informational content
model Article {
  id              String           @id @default(cuid())
  title           String
  slug            String           @unique
  excerpt         String?          @db.Text
  content         String           @db.Text
  featuredImage   String?
  status          ContentStatus    @default(DRAFT)
  publishedAt     DateTime?
  authorId        String
  author          User             @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categoryId      String
  category        Category         @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  tags            Tag[]            @relation("ArticleTags")
  seoMetadata     SeoMetadata?
  versions        ContentVersion[]
  readTime        Int?             // Reading time in minutes
  viewCount       Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([slug])
  @@index([status])
  @@index([publishedAt])
  @@index([authorId])
  @@index([categoryId])
}

// Content Type: Guide
// For comprehensive how-to guides and tutorials
model Guide {
  id              String           @id @default(cuid())
  title           String
  slug            String           @unique
  excerpt         String?          @db.Text
  content         String           @db.Text
  featuredImage   String?
  status          ContentStatus    @default(DRAFT)
  publishedAt     DateTime?
  authorId        String
  author          User             @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categoryId      String
  category        Category         @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  tags            Tag[]            @relation("GuideTags")
  seoMetadata     SeoMetadata?
  versions        ContentVersion[]
  steps           GuideStep[]
  difficulty      Difficulty       @default(INTERMEDIATE)
  estimatedTime   Int?             // Estimated completion time in minutes
  viewCount       Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([slug])
  @@index([status])
  @@index([publishedAt])
  @@index([authorId])
  @@index([categoryId])
}

// Guide steps for structured tutorials
model GuideStep {
  id          String   @id @default(cuid())
  guideId     String
  guide       Guide    @relation(fields: [guideId], references: [id], onDelete: Cascade)
  stepNumber  Int
  title       String
  content     String   @db.Text
  image       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([guideId, stepNumber])
  @@index([guideId])
}

// Content Type: Calculator
// For interactive financial calculators
model Calculator {
  id              String           @id @default(cuid())
  title           String
  slug            String           @unique
  description     String?          @db.Text
  calculatorType  CalculatorType
  config          String           @db.Text // JSON configuration for calculator inputs/logic
  status          ContentStatus    @default(DRAFT)
  publishedAt     DateTime?
  authorId        String
  author          User             @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categoryId      String
  category        Category         @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  tags            Tag[]            @relation("CalculatorTags")
  seoMetadata     SeoMetadata?
  versions        ContentVersion[]
  usageCount      Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([slug])
  @@index([status])
  @@index([publishedAt])
  @@index([authorId])
  @@index([categoryId])
}

enum CalculatorType {
  MORTGAGE
  AFFORDABILITY
  REFINANCE
  INVESTMENT_ROI
  AMORTIZATION
  DEBT_TO_INCOME
  CLOSING_COSTS
  RENT_VS_BUY
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

// Category system for content organization
model Category {
  id          String       @id @default(cuid())
  name        String       @unique
  slug        String       @unique
  description String?      @db.Text
  parentId    String?
  parent      Category?    @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children    Category[]   @relation("CategoryHierarchy")
  segment     Segment      // Residential, Investment, Commercial
  articles    Article[]
  guides      Guide[]
  calculators Calculator[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([slug])
  @@index([segment])
}

enum Segment {
  RESIDENTIAL
  INVESTMENT
  COMMERCIAL
}

// Tag system for flexible categorization
model Tag {
  id          String       @id @default(cuid())
  name        String       @unique
  slug        String       @unique
  articles    Article[]    @relation("ArticleTags")
  guides      Guide[]      @relation("GuideTags")
  calculators Calculator[] @relation("CalculatorTags")
  createdAt   DateTime     @default(now())

  @@index([slug])
}

// SEO Metadata for all content types
model SeoMetadata {
  id                String      @id @default(cuid())
  metaTitle         String
  metaDescription   String      @db.Text
  focusKeyword      String?
  canonicalUrl      String?
  ogTitle           String?
  ogDescription     String?     @db.Text
  ogImage           String?
  twitterCard       String?
  noIndex           Boolean     @default(false)
  noFollow          Boolean     @default(false)
  schema            String?     @db.Text // JSON-LD structured data

  // Polymorphic relationship
  articleId         String?     @unique
  article           Article?    @relation(fields: [articleId], references: [id], onDelete: Cascade)
  guideId           String?     @unique
  guide             Guide?      @relation(fields: [guideId], references: [id], onDelete: Cascade)
  calculatorId      String?     @unique
  calculator        Calculator? @relation(fields: [calculatorId], references: [id], onDelete: Cascade)

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([articleId])
  @@index([guideId])
  @@index([calculatorId])
}

// Content versioning for publishing workflow
model ContentVersion {
  id            String        @id @default(cuid())
  versionNumber Int
  content       String        @db.Text
  changeLog     String?       @db.Text
  createdById   String
  createdBy     User          @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Polymorphic relationship
  articleId     String?
  article       Article?      @relation(fields: [articleId], references: [id], onDelete: Cascade)
  guideId       String?
  guide         Guide?        @relation(fields: [guideId], references: [id], onDelete: Cascade)
  calculatorId  String?
  calculator    Calculator?   @relation(fields: [calculatorId], references: [id], onDelete: Cascade)

  createdAt     DateTime      @default(now())

  @@index([articleId])
  @@index([guideId])
  @@index([calculatorId])
  @@index([createdById])
}

enum ContentStatus {
  DRAFT
  IN_REVIEW
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

// Lead Capture System
// Stores leads from multi-step forms throughout the site
model Lead {
  id                String       @id @default(cuid())

  // Lead Source - how they were captured
  leadSource        LeadSource   @default(FORM)

  // Segmentation
  segment           Segment      // Which mortgage segment
  loanType          LoanType     // Specific loan type

  // Property Details
  propertyType      PropertyType?
  propertyValue     Int?         // Estimated property value
  purchasePrice     Int?         // Purchase price for new purchases
  propertyLocation  String?      // City, State or ZIP

  // Contact Information
  name              String
  email             String
  phone             String?

  // Qualification Details
  creditRange       CreditRange?
  downPayment       Int?         // Down payment amount in dollars
  downPaymentPercent Int?        // Down payment as percentage
  timeline          Timeline?    // When they need the loan
  currentlyOwn      Boolean?     // Do they currently own a home
  employmentStatus  EmploymentStatus?
  annualIncome      Int?         // Annual household income

  // Lead Scoring & Management
  score             Int          @default(0) // 0-100 lead quality score
  scoreCategory     String?      // hot, warm, cold
  status            LeadStatus   @default(NEW)
  notes             String?      @db.Text

  // Agent Assignment
  assignedAgentId   String?
  assignedAgent     Agent?       @relation("AgentLeads", fields: [assignedAgentId], references: [id], onDelete: SetNull)
  assignedAt        DateTime?    // When assigned to agent

  // Relations to AI features
  conversation      Conversation?
  readinessAssessment ReadinessAssessment?

  // TCPA Compliance
  tcpaConsent       Boolean      @default(false)
  consentTimestamp  DateTime?
  consentIp         String?

  // Tracking
  sourceUrl         String?      // URL/page where lead was captured
  utmSource         String?      // Marketing attribution
  utmMedium         String?
  utmCampaign       String?
  ipAddress         String?
  userAgent         String?

  // Webhook status
  maxBountySubmitted Boolean     @default(false)
  maxBountyResponse  String?     @db.Text

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  contactedAt       DateTime?    // When lead was first contacted
  convertedAt       DateTime?    // When lead converted to customer

  @@index([email])
  @@index([status])
  @@index([score])
  @@index([segment])
  @@index([leadSource])
  @@index([createdAt])
  @@index([assignedAgentId])
}

enum LoanType {
  // Residential
  PURCHASE
  REFINANCE
  CASH_OUT_REFINANCE
  HOME_EQUITY_LOAN
  HOME_EQUITY_LINE
  FHA_LOAN
  VA_LOAN
  USDA_LOAN
  JUMBO_LOAN

  // Investment
  INVESTMENT_PROPERTY
  FIX_AND_FLIP
  RENTAL_PORTFOLIO
  DSCR_LOAN
  HARD_MONEY

  // Commercial
  COMMERCIAL_PURCHASE
  COMMERCIAL_REFINANCE
  SBA_LOAN
  BRIDGE_LOAN
  CONSTRUCTION_LOAN
}

enum PropertyType {
  SINGLE_FAMILY
  CONDO
  TOWNHOUSE
  MULTI_FAMILY
  MANUFACTURED
  LAND
  COMMERCIAL_OFFICE
  COMMERCIAL_RETAIL
  COMMERCIAL_INDUSTRIAL
  COMMERCIAL_MIXED_USE
}

enum CreditRange {
  EXCELLENT_740_PLUS
  GOOD_670_739
  FAIR_580_669
  POOR_BELOW_580
  NOT_SURE
}

enum Timeline {
  ASAP
  WITHIN_30_DAYS
  ONE_TO_THREE_MONTHS
  THREE_TO_SIX_MONTHS
  SIX_PLUS_MONTHS
  JUST_RESEARCHING
}

enum EmploymentStatus {
  EMPLOYED_W2
  SELF_EMPLOYED
  RETIRED
  NOT_EMPLOYED
  OTHER
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  QUOTE_SENT
  IN_PROCESS
  CONVERTED
  CLOSED_LOST
  NURTURE
}

// Lead Source - how the lead was captured
enum LeadSource {
  AI_ADVISOR       // From AI chatbot conversation
  READINESS_SCORE  // From Mortgage Readiness Score assessment
  FORM             // Traditional multi-step form
  CALCULATOR       // From calculator CTA
}

// Agent model for local agent/lender routing
model Agent {
  id              String       @id @default(cuid())
  name            String
  email           String       @unique
  phone           String?
  company         String?

  // Service area & specialization
  locations       String[]     // Cities/metros they serve (e.g., ["Los Angeles", "San Diego"])
  states          String[]     // States licensed in (e.g., ["CA", "AZ"])
  loanTypes       LoanType[]   // Loan types they handle
  segments        Segment[]    // Segments they specialize in

  // Capacity management
  weeklyCapacity  Int          @default(20)  // Max leads per week
  currentWeekLeads Int         @default(0)   // Leads assigned this week

  // Status & performance
  status          AgentStatus  @default(ACTIVE)
  responseRate    Float?       // Average response time in hours
  conversionRate  Float?       // Lead to close rate
  rating          Float?       // Average rating 1-5

  // Relations
  assignedLeads   Lead[]       @relation("AgentLeads")

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([status])
  @@index([states])
}

enum AgentStatus {
  ACTIVE
  PAUSED
  INACTIVE
}

// Conversation model for AI Advisor chat transcripts
model Conversation {
  id              String       @id @default(cuid())

  // Link to lead (created when contact info captured)
  leadId          String?      @unique
  lead            Lead?        @relation(fields: [leadId], references: [id], onDelete: SetNull)

  // Session tracking
  sessionId       String       @unique  // Browser session ID

  // Conversation data
  messages        Message[]

  // Extracted qualification data
  loanType        LoanType?
  propertyType    PropertyType?
  location        String?
  timeline        Timeline?
  creditRange     CreditRange?

  // Status
  status          ConversationStatus @default(ACTIVE)
  leadCaptured    Boolean      @default(false)

  // Tracking
  pageUrl         String?      // Page where conversation started

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([sessionId])
  @@index([status])
}

enum ConversationStatus {
  ACTIVE
  COMPLETED
  ABANDONED
}

// Individual chat messages
model Message {
  id              String       @id @default(cuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role            MessageRole
  content         String       @db.Text

  createdAt       DateTime     @default(now())

  @@index([conversationId])
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// Mortgage Readiness Score Assessment
model ReadinessAssessment {
  id              String       @id @default(cuid())

  // Link to lead (created when email captured)
  leadId          String?      @unique
  lead            Lead?        @relation(fields: [leadId], references: [id], onDelete: SetNull)

  // Session tracking
  sessionId       String       @unique

  // Assessment responses (stored as JSON for flexibility)
  responses       String       @db.Text  // JSON object of question -> answer

  // Calculated scores
  totalScore      Int          // 0-100
  creditScore     Int          // 0-25
  employmentScore Int          // 0-15
  incomeScore     Int          // 0-15
  debtScore       Int          // 0-15
  downPaymentScore Int         // 0-15
  preApprovalScore Int         // 0-10
  noNegativeEventsScore Int    // 0-5

  // Score category
  category        ScoreCategory

  // Completion status
  completed       Boolean      @default(false)
  emailCaptured   Boolean      @default(false)
  shared          Boolean      @default(false)  // Did they share on social?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([sessionId])
  @@index([totalScore])
  @@index([category])
}

enum ScoreCategory {
  MORTGAGE_READY    // 80-100
  ALMOST_THERE      // 60-79
  GETTING_PREPARED  // 40-59
  BUILDING_FOUNDATION // 0-39
}
